<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fitting Data · SPRFittingPaper2023.jl</title><meta name="title" content="Fitting Data · SPRFittingPaper2023.jl"/><meta property="og:title" content="Fitting Data · SPRFittingPaper2023.jl"/><meta property="twitter:title" content="Fitting Data · SPRFittingPaper2023.jl"/><meta name="description" content="Documentation for SPRFittingPaper2023.jl."/><meta property="og:description" content="Documentation for SPRFittingPaper2023.jl."/><meta property="twitter:description" content="Documentation for SPRFittingPaper2023.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SPRFittingPaper2023.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../forward_simulation/">Forward Model</a></li><li><a class="tocitem" href="../surrogate_construction/">Surrogate Construction</a></li><li class="is-active"><a class="tocitem" href>Fitting Data</a><ul class="internal"><li><a class="tocitem" href="#Setup"><span>Setup</span></a></li><li><a class="tocitem" href="#Estimating-Best-Fit-Parameters-to-an-SPR-Dataset"><span>Estimating Best Fit Parameters to an SPR Dataset</span></a></li><li><a class="tocitem" href="#General-Workflow"><span>General Workflow</span></a></li><li><a class="tocitem" href="#Bibliography"><span>Bibliography</span></a></li></ul></li><li><a class="tocitem" href="../SPRFitting_api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Fitting Data</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fitting Data</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/isaacsas/SPRFittingPaper2023.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/isaacsas/SPRFittingPaper2023.jl/blob/main/docs/src/fitting.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting-to-SPR-Data"><a class="docs-heading-anchor" href="#Fitting-to-SPR-Data">Fitting to SPR Data</a><a id="Fitting-to-SPR-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-to-SPR-Data" title="Permalink"></a></h1><p>In this tutorial we will illustrate how to fit the surrogate model to SPR data to estimate <span>$k_{\text{on}}$</span>, <span>$k_{\text{off}}$</span>, k_{\on,b} serial on any computer, and our workflow for building large surrogates on clusters (specific to the Grid Engine queuing system based cluster we use).</p><h2 id="Setup"><a class="docs-heading-anchor" href="#Setup">Setup</a><a id="Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Setup" title="Permalink"></a></h2><p>We begin by installing the packages we need in a clean environment:</p><pre><code class="language-julia hljs">using Pkg

# create a new environment for the surrogate constructions
Pkg.activate(&quot;fitting_env&quot;) 
Pkg.add(url=&quot;https://github.com/isaacsas/SPRFittingPaper2023.jl.git&quot;)</code></pre><h2 id="Estimating-Best-Fit-Parameters-to-an-SPR-Dataset"><a class="docs-heading-anchor" href="#Estimating-Best-Fit-Parameters-to-an-SPR-Dataset">Estimating Best Fit Parameters to an SPR Dataset</a><a id="Estimating-Best-Fit-Parameters-to-an-SPR-Dataset-1"></a><a class="docs-heading-anchor-permalink" href="#Estimating-Best-Fit-Parameters-to-an-SPR-Dataset" title="Permalink"></a></h2><p>We wil work with the same SPR dataset as in the <a href="../forward_simulation/#Forward-Model-Simulation">Forward Model Simulation</a> tutorial. As described in [1], our general approach will be to use the XNES optimizer from BlackBoxOptim.jl to minimize the difference between the SPR data and the surrogate&#39;s predicted SPR traces. XNES is a stochastic natural evolution optimizer that we have found often gives the best fits among many optimizer choices. We use this optimizer via Optimization.jl, which allows for the easy selection of different optimizer choices. As XNES is stochastic, we will run the parameter estimation process <code>nfits</code> times, and select parameters from the run with the minimal loss as our final estimates. </p><p>We&#39;ll use the full surrogate from [1], which can be downloaded <a href="https://doi.org/10.6084/m9.figshare.26936854">here</a>.</p><p>We being by defining some variables related to the fitting process:</p><pre><code class="language-julia hljs">nfits = 100    # how many fits to run and then take the minimum over
nsims = 250    # number of simulations to average when plotting
logCP_optrange = (1.0, 5.0)  # allowable log-space range of CP values </code></pre><p>Next we set the location of the surrogate:</p><pre><code class="language-julia hljs">surfile = &quot;PATH_TO_DOWNLOADED_SURROGATE.jld&quot;</code></pre><p>We are now load the surrogate and SPR data:</p><pre><code class="language-julia hljs"># load the surrogate
surrogate = Surrogate(surfile)
sps = surrogate.surpars

# range of CP values to use
optpar_ranges = [logCP_optrange]

# load the aligned SPR data from input CSV file
datadir = joinpath(@__DIR__, &quot;..&quot;, &quot;..&quot;, &quot;data&quot;)
aligned_data_fname = joinpath(datadir, &quot;Data_FC4_10-05-22_Protein07_FD-11A_RBD-13.8_aligned.csv&quot;)
aligneddat = get_aligned_data(aligned_data_fname)</code></pre><p>Finally, we now run the optimizer <code>nfits</code> times, taking as our parameter estimates the fit with the mimimal loss:</p><pre><code class="language-julia hljs">optsol, best_pars = fit_spr_data(surrogate, aligneddat, optpar_ranges)
for i in 2:nfits
    optsol_new, best_pars_new = fit_spr_data(surrogate, aligneddat, optpar_ranges)
    if optsol_new.minimum &lt; optsol.minimum
        optsol = optsol_new
        best_pars = best_pars_new
    end
end</code></pre><p>We find the best fit parameters, <code>[kon, koff, konb, reach, CP]</code>, are</p><pre><code class="language-julia hljs">best_pars = [5.2859956892261876e-5, 0.04086857480653136, 0.7801815024260655, 31.898843844047246, 128.56923492479402]</code></pre><p>We can now plot (and output) a figure comparing our fits to the SPR data</p><pre><code class="language-julia hljs"># number of simulations to average over in making the plot
simpars.nsims = nsims

# save a figure showing the fit to the SPR data
OUTDIR = tempdir()
figfile = joinpath(OUTDIR, &quot;fit_curves.png&quot;)
visualisefit(optsol, aligneddat, surrogate, simpars, figfile)</code></pre><p>Which gives</p><p><img src="../fitting_data/fit_curves.png" alt="spr_fit"/></p><p>Here the SPR data is shown in black and the average predicted responses in color. Finally, we can save a spreadsheet with our fits and parameter estimates via</p><pre><code class="language-julia hljs">curvefile = joinpath(OUTDIR, &quot;parameters.xlsx&quot;)
savefit(optsol, aligneddat, surrogate, simpars, curvefile)</code></pre><p>For this example the file <a href="../fitting_data/parameters.xlsx_fit.xlsx">here</a> shows the resulting Excel spreadsheet. Note that the second sheet within it shows the parameter estimates.</p><h2 id="General-Workflow"><a class="docs-heading-anchor" href="#General-Workflow">General Workflow</a><a id="General-Workflow-1"></a><a class="docs-heading-anchor-permalink" href="#General-Workflow" title="Permalink"></a></h2><p>A more detailed workflow that processes multiple SPR inputs, includes monovalent fits, and systematically writes output files for each fit can be downloaded <a href="../fitting_workflow/Fitting_Examples.zip">here</a>. This file contains three sub-folders:</p><ol><li><em>Experiments</em> contains a set of CSVs corresponding to processed SPR experiments for fitting.</li><li><em>Code</em> contains a file &quot;readme.md&quot; with instructions on how to use/modify the included &quot;ParameterFitting_Example.jl&quot; script to fit a collection of experiments.</li><li><em>Surrogates</em> is where you should place the downloaded surrogate from the manuscript, which is available <a href="https://doi.org/10.6084/m9.figshare.26936854">here</a> (or place whatever surrogate you wish to use).</li></ol><h2 id="Bibliography"><a class="docs-heading-anchor" href="#Bibliography">Bibliography</a><a id="Bibliography-1"></a><a class="docs-heading-anchor-permalink" href="#Bibliography" title="Permalink"></a></h2><ol><li>A. Huhn, D. Nissley, ..., C. M. Deane, S. A. Isaacson, and O. Dushek, <em>Analysis of emergent bivalent antibody binding identifies the molecular reach as a critical determinant of SARS-CoV-2 neutralisation potency</em>, in review, <a href="https://www.biorxiv.org/content/10.1101/2023.09.06.556503v2">available on bioRxiv</a> (2024).</li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../surrogate_construction/">« Surrogate Construction</a><a class="docs-footer-nextpage" href="../SPRFitting_api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Tuesday 10 September 2024 21:41">Tuesday 10 September 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
